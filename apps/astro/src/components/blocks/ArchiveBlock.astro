---
/**
 * Archive Block Component
 * 
 * Displays a list of items from a collection (posts, archive items, etc.)
 */

interface Props {
  heading?: string;
  collection: 'posts' | 'archive-items' | 'pages' | 'people' | 'places' | 'custom-items';
  categories?: any[];
  tags?: any[];
  limit?: number;
  layout?: 'grid' | 'list' | 'cards';
  showExcerpt?: boolean;
  showImage?: boolean;
  showDate?: boolean;
  linkTo?: string;
  contentType?: any;
}

const {
  heading,
  collection = 'posts',
  categories,
  tags,
  limit = 6,
  layout = 'grid',
  showExcerpt = true,
  showImage = true,
  showDate = true,
  linkTo,
  contentType
} = Astro.props;

// Fetch items from the collection
let items: any[] = [];
try {
  const cmsUrl = import.meta.env.PUBLIC_CMS_URL || 'http://localhost:3000';
  const statusQuery = collection === 'custom-items' ? '&where[status][equals]=published' : '';
  const contentTypeId = collection === 'custom-items' && contentType ? (typeof contentType === 'object' ? contentType.id : contentType) : null;
  const contentTypeQuery = contentTypeId ? `&where[contentType][equals]=${contentTypeId}` : '';

  // Add category/tag filtering
  const categoryIds = categories?.map((cat: any) => typeof cat === 'object' ? cat.id : cat).filter(Boolean);
  const tagIds = tags?.map((tag: any) => typeof tag === 'object' ? tag.id : tag).filter(Boolean);
  const categoryQuery = categoryIds && categoryIds.length > 0 ? `&where[categories][in]=${categoryIds.join(',')}` : '';
  const tagQuery = tagIds && tagIds.length > 0 ? `&where[tags][in]=${tagIds.join(',')}` : '';

  const response = await fetch(`${cmsUrl}/api/${collection}?limit=${limit}&sort=-createdAt&depth=1${statusQuery}${contentTypeQuery}${categoryQuery}${tagQuery}`);
  if (response.ok) {
    const data = await response.json();
    items = data.docs || [];
  }
} catch (e) {
  console.error(`Failed to fetch ${collection}:`, e);
}

// Get the URL path for items
const getItemUrl = (item: any) => {
  const paths: Record<string, string> = {
    posts: '/blog',
    'archive-items': '/archive-items',
    pages: '',
    people: '/people',
    places: '/places',
    'custom-items': '/items',
  };
  if (collection === 'custom-items') {
    const typeSlug = typeof item.contentType === 'object' ? item.contentType.slug : null;
    const archiveSlug = typeof item.contentType === 'object' ? item.contentType.archiveSlug : null;
    const resolvedType = archiveSlug ? archiveSlug.replace(/^\/?(items\/)?/, '') : typeSlug;
    if (resolvedType) {
      return `/items/${resolvedType}/${item.slug}`;
    }
  }
  return `${paths[collection]}/${item.slug}`;
};

// Get image from item
const getItemImage = (item: any) => {
  return item.featuredImage?.url || item.media?.[0]?.image?.url || null;
};

// Get excerpt from item
const getItemExcerpt = (item: any) => {
  return item.excerpt || item.description || '';
};

const columnClasses: Record<string, string> = {
  grid: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6',
  list: 'space-y-4',
  cards: 'grid grid-cols-1 md:grid-cols-2 gap-8',
};
---

<section class="py-12">
  <div class="container">
    {heading && (
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-2xl font-bold">{heading}</h2>
        {linkTo && (
          <a href={linkTo} class="text-blue-600 hover:text-blue-700 dark:text-blue-400">
            View all â†’
          </a>
        )}
      </div>
    )}
    
    {items.length === 0 ? (
      <p class="text-center text-gray-500 dark:text-gray-400 py-8">
        No items found in this collection.
      </p>
    ) : (
      <div class={columnClasses[layout]}>
        {items.map((item) => (
          <a 
            href={getItemUrl(item)} 
            class={`
              group block
              ${layout === 'grid' ? 'bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow' : ''}
              ${layout === 'list' ? 'flex gap-4 p-4 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors' : ''}
              ${layout === 'cards' ? 'bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow' : ''}
            `}
          >
            {/* Image */}
            {showImage && getItemImage(item) && (
              <div class={`
                overflow-hidden
                ${layout === 'grid' ? 'h-48' : ''}
                ${layout === 'list' ? 'w-24 h-24 flex-shrink-0 rounded-lg' : ''}
                ${layout === 'cards' ? 'h-56' : ''}
              `}>
                <img 
                  src={getItemImage(item)} 
                  alt={item.title}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
            )}
            
            {/* Content */}
            <div class={`
              ${layout === 'grid' ? 'p-4' : ''}
              ${layout === 'list' ? 'flex-1 min-w-0' : ''}
              ${layout === 'cards' ? 'p-6' : ''}
            `}>
              <h3 class={`
                font-semibold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors
                ${layout === 'list' ? 'truncate' : ''}
                ${layout === 'cards' ? 'text-xl' : ''}
              `}>
                {item.title}
              </h3>
              
              {showExcerpt && getItemExcerpt(item) && (
                <p class={`
                  text-gray-600 dark:text-gray-300 mt-2
                  ${layout === 'grid' ? 'text-sm line-clamp-2' : ''}
                  ${layout === 'list' ? 'text-sm line-clamp-1' : ''}
                  ${layout === 'cards' ? 'line-clamp-3' : ''}
                `}>
                  {getItemExcerpt(item)}
                </p>
              )}
              
              {showDate && (item.publishedAt || item.createdAt) && (
                <p class="text-sm text-gray-400 mt-2">
                  {new Date(item.publishedAt || item.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                  })}
                </p>
              )}
            </div>
          </a>
        ))}
      </div>
    )}
  </div>
</section>
