---
/**
 * Block Renderer Component
 * 
 * Dynamically renders content blocks based on their type.
 * This is the main entry point for rendering page content.
 */

import HeroBlock from './HeroBlock.astro';
import ContentBlock from './ContentBlock.astro';
import MediaBlock from './MediaBlock.astro';
import CTABlock from './CTABlock.astro';
import GalleryBlock from './GalleryBlock.astro';
import GridBlock from './GridBlock.astro';
import TimelineBlock from './TimelineBlock.astro';
import ArchiveBlock from './ArchiveBlock.astro';
import FormBlock from './FormBlock.astro';
import StatsBlock from './StatsBlock.astro';
import TestimonialsBlock from './TestimonialsBlock.astro';
import FeaturesBlock from './FeaturesBlock.astro';
import TeamBlock from './TeamBlock.astro';
import FAQBlock from './FAQBlock.astro';

interface Props {
  blocks: any[];
}

const { blocks = [] } = Astro.props;

// Map block types to components
const blockComponents: Record<string, any> = {
  hero: HeroBlock,
  content: ContentBlock,
  media: MediaBlock,
  cta: CTABlock,
  gallery: GalleryBlock,
  grid: GridBlock,
  timeline: TimelineBlock,
  archive: ArchiveBlock,
  form: FormBlock,
  stats: StatsBlock,
  testimonials: TestimonialsBlock,
  features: FeaturesBlock,
  team: TeamBlock,
  faq: FAQBlock,
};

// Map Payload block shapes to Astro component props
const mapBlockProps = (block: any) => {
  switch (block.blockType) {
    case 'hero':
      return {
        heading: block.heading,
        subheading: block.subheading,
        backgroundImage: block.image?.url ? { url: block.image.url, alt: block.image.alt } : undefined,
        alignment: block.textAlign || 'center',
        height: block.type === 'fullscreen' ? 'full' : 'medium',
        overlay: block.overlay !== 'none',
        overlayOpacity: 50,
        buttons: (block.links || []).map((link: any) => ({
          label: link.label,
          link: link.url || (link.page?.slug ? `/${link.page.slug}` : '#'),
          variant: link.variant || 'primary',
        })),
      };
    case 'content':
      return {
        content: block.columns?.[0]?.richText || block.richText || block.content,
        columns: (block.columns?.length || 1) > 1 ? 'two' : 'one',
        backgroundColor: block.backgroundColor && block.backgroundColor !== 'none' ? block.backgroundColor : undefined,
      };
    case 'media':
      return {
        media: block.media?.url ? {
          url: block.media.url,
          alt: block.media.alt,
          mimeType: block.media.mimeType,
          width: block.media.width,
          height: block.media.height,
        } : undefined,
        caption: block.caption,
        size: block.size === 'fullWidth' ? 'full' : block.size === 'small' ? 'small' : block.size === 'default' ? 'medium' : 'large',
        alignment: block.position || 'center',
      };
    case 'cta':
      return {
        heading: block.heading,
        text: block.description,
        style: block.style === 'banner' || block.style === 'card' ? 'gradient' : block.style === 'inline' ? 'default' : 'default',
        buttons: (block.links || []).map((link: any) => ({
          label: link.label,
          link: link.url || (link.page?.slug ? `/${link.page.slug}` : '#'),
          variant: link.variant || 'primary',
        })),
      };
    case 'gallery':
      return {
        heading: block.heading,
        images: (block.images || []).map((img: any) => ({
          image: img.image?.url ? { url: img.image.url, alt: img.image.alt, width: img.image.width, height: img.image.height } : undefined,
          caption: img.caption,
        })).filter((img: any) => img.image),
        layout: block.layout || 'grid',
        columns: Number(block.columns || 3),
      };
    case 'grid':
      return {
        heading: block.heading,
        items: block.items || [],
      };
    case 'timeline':
      return {
        heading: block.heading,
        events: block.events || block.timeline || [],
      };
    case 'archive':
      return {
        heading: block.heading,
        collection: block.relationTo || block.collection || 'posts',
        limit: block.limit || 6,
        layout: block.layout || 'grid',
        showExcerpt: block.showExcerpt ?? true,
        showImage: block.showImage ?? true,
        showDate: block.showDate ?? true,
        linkTo: block.linkTo || block.viewAllLink,
        contentType: block.contentType,
      };
    case 'form':
      return {
        form: block.form,
        heading: block.heading,
        description: block.description,
      };
    case 'stats':
      return {
        items: block.items || [],
      };
    case 'testimonials':
      return {
        heading: block.heading,
        items: block.items || [],
      };
    case 'features':
      return {
        heading: block.heading,
        features: block.features || [],
      };
    case 'team':
      return {
        heading: block.heading,
        members: block.members || [],
      };
    case 'faq':
      return {
        heading: block.heading,
        items: block.items || [],
      };
    default:
      return block;
  }
};
---

<div class="blocks-container">
  {blocks.map((block: any, index: number) => {
    const BlockComponent = blockComponents[block.blockType];
    
    if (!BlockComponent) {
      console.warn(`Unknown block type: ${block.blockType}`);
      return null;
    }
    
    const props = mapBlockProps(block);
    return <BlockComponent {...props} key={block.id ?? `${block.blockType}-${index}`} />;
  })}
</div>
