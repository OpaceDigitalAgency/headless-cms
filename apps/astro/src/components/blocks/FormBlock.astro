---
/**
 * Form Block Component
 * 
 * Renders forms created with Payload's form builder plugin.
 */

interface Props {
  form?: {
    id: string;
    title: string;
    fields?: Array<{
      name: string;
      label?: string;
      blockType: string;
      required?: boolean;
      width?: number;
      defaultValue?: string;
      options?: Array<{ label: string; value: string }>;
    }>;
    submitButtonLabel?: string;
    confirmationType?: 'message' | 'redirect';
    confirmationMessage?: any;
    redirect?: { url: string };
  };
  heading?: string;
}

const { form, heading } = Astro.props;

if (!form) return null;

const cmsUrl = import.meta.env.PUBLIC_CMS_URL || 'http://localhost:3000';
---

<section class="py-12">
  <div class="container max-w-2xl">
    {heading && (
      <h2 class="text-2xl font-bold mb-6 text-center">{heading}</h2>
    )}
    
    <form 
      class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8"
      data-form-id={form.id}
      id={`form-${form.id}`}
    >
      <div class="space-y-6">
        {form.fields?.map((field) => {
          const width = field.width || 100;
          const widthClass = width === 50 ? 'w-1/2' : width === 33 ? 'w-1/3' : 'w-full';
          
          return (
            <div class={`${widthClass} inline-block align-top px-2`}>
              {field.blockType === 'text' && (
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                  <input 
                    type="text"
                    name={field.name}
                    required={field.required}
                    defaultValue={field.defaultValue}
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                </div>
              )}
              
              {field.blockType === 'email' && (
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                  <input 
                    type="email"
                    name={field.name}
                    required={field.required}
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                </div>
              )}
              
              {field.blockType === 'textarea' && (
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                  <textarea 
                    name={field.name}
                    required={field.required}
                    rows={4}
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                </div>
              )}
              
              {field.blockType === 'select' && (
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                  <select 
                    name={field.name}
                    required={field.required}
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  >
                    <option value="">Select...</option>
                    {field.options?.map((option) => (
                      <option value={option.value}>{option.label}</option>
                    ))}
                  </select>
                </div>
              )}
              
              {field.blockType === 'checkbox' && (
                <div class="flex items-center gap-2">
                  <input 
                    type="checkbox"
                    name={field.name}
                    required={field.required}
                    id={`field-${field.name}`}
                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <label for={`field-${field.name}`} class="text-sm text-gray-700 dark:text-gray-300">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                </div>
              )}
              
              {field.blockType === 'number' && (
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    {field.label || field.name}
                    {field.required && <span class="text-red-500">*</span>}
                  </label>
                  <input 
                    type="number"
                    name={field.name}
                    required={field.required}
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                  />
                </div>
              )}
            </div>
          );
        })}
      </div>
      
      <div class="mt-8">
        <button 
          type="submit"
          class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
        >
          {form.submitButtonLabel || 'Submit'}
        </button>
      </div>
      
      {/* Success/Error messages */}
      <div class="form-message hidden mt-4 p-4 rounded-lg" />
    </form>
  </div>
</section>

<script define:vars={{ formId: form.id, cmsUrl, confirmationType: form.confirmationType, redirectUrl: form.redirect?.url }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById(`form-${formId}`);
    if (!form) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      const messageEl = form.querySelector('.form-message');
      const submitBtn = form.querySelector('button[type="submit"]');
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        const response = await fetch(`${cmsUrl}/api/form-submissions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            form: formId,
            submissionData: Object.entries(data).map(([field, value]) => ({ field, value })),
          }),
        });
        
        if (response.ok) {
          if (confirmationType === 'redirect' && redirectUrl) {
            window.location.href = redirectUrl;
          } else {
            messageEl.className = 'form-message mt-4 p-4 rounded-lg bg-green-100 text-green-700';
            messageEl.textContent = 'Thank you! Your submission has been received.';
            form.reset();
          }
        } else {
          throw new Error('Submission failed');
        }
      } catch (error) {
        messageEl.className = 'form-message mt-4 p-4 rounded-lg bg-red-100 text-red-700';
        messageEl.textContent = 'Something went wrong. Please try again.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = form.submitButtonLabel || 'Submit';
      }
    });
  });
</script>
