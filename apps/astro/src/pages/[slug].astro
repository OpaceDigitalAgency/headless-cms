---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlockRenderer from '../components/blocks/BlockRenderer.astro';
import { getPages, getPageBySlug } from '../lib/payload';

// Generate static paths for all published pages
export async function getStaticPaths() {
  const pages = await getPages({ limit: 1000 });
  
  return pages.docs
    .filter((page) => page.slug !== 'home') // Home is handled by index.astro
    .map((page) => ({
      params: { slug: page.slug },
      props: { page },
    }));
}

const { page } = Astro.props;

// Fallback fetch if page not in props (shouldn't happen with static generation)
const pageData = page || await getPageBySlug(Astro.params.slug);

if (!pageData) {
  return Astro.redirect('/404');
}

const title = pageData.meta?.title || pageData.title;
const description = pageData.meta?.description || '';
const image = pageData.meta?.image?.url || '';
const blocks = [
  // If a page-level hero exists, inject it as the first block for rendering
  ...(pageData.hero ? [{
    blockType: 'hero',
    heading: pageData.hero.heading,
    subheading: pageData.hero.subheading,
    image: pageData.hero.image,
    links: pageData.hero.links,
    type: pageData.hero.type,
    overlay: pageData.hero.overlay,
    textAlign: pageData.hero.textAlign,
  }] : []),
  ...(pageData.content || []),
];
---

<BaseLayout title={title} description={description} image={image}>
  <article>
    {/* Page Header - only show if no hero block */}
    {!blocks.some((b: any) => b.blockType === 'hero') && (
      <header class="py-16 bg-gray-50 dark:bg-gray-800/50">
        <div class="container">
          <h1 class="text-4xl font-bold tracking-tight">{pageData.title}</h1>
        </div>
      </header>
    )}
    
    {/* Render all blocks */}
    <BlockRenderer blocks={blocks} />
  </article>
</BaseLayout>
