---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getPages, getPageBySlug } from '@/lib/payload';

// Generate static paths for all published pages
export async function getStaticPaths() {
  const pages = await getPages({ limit: 1000 });
  
  return pages.docs
    .filter((page) => page.slug !== 'home') // Home is handled by index.astro
    .map((page) => ({
      params: { slug: page.slug },
      props: { page },
    }));
}

const { page } = Astro.props;

// Fallback fetch if page not in props (shouldn't happen with static generation)
const pageData = page || await getPageBySlug(Astro.params.slug);

if (!pageData) {
  return Astro.redirect('/404');
}

const title = pageData.meta?.title || pageData.title;
const description = pageData.meta?.description || '';
const image = pageData.meta?.image?.url || '';
---

<BaseLayout title={title} description={description} image={image}>
  <article class="py-16">
    <div class="container">
      <header class="mb-12">
        <h1 class="text-4xl font-bold tracking-tight">{pageData.title}</h1>
      </header>
      
      <!-- Render blocks -->
      {pageData.layout?.map((block: any) => {
        switch (block.blockType) {
          case 'hero':
            return (
              <section class="relative bg-gradient-to-br from-blue-600 to-blue-800 py-24 text-white rounded-xl mb-12">
                <div class="max-w-3xl mx-auto text-center">
                  <h2 class="text-4xl font-bold">{block.heading}</h2>
                  {block.subheading && (
                    <p class="mt-4 text-xl text-blue-100">{block.subheading}</p>
                  )}
                </div>
              </section>
            );
          case 'content':
            return (
              <section class="prose-custom mb-12" set:html={block.content_html || ''} />
            );
          case 'cta':
            return (
              <section class="rounded-xl bg-gray-100 dark:bg-gray-800 p-8 text-center mb-12">
                <h2 class="text-2xl font-bold">{block.heading}</h2>
                {block.subheading && (
                  <p class="mt-2 text-gray-600 dark:text-gray-300">{block.subheading}</p>
                )}
                {block.links?.map((link: any) => (
                  <a href={link.url} class="btn-primary mt-6 inline-block">
                    {link.label}
                  </a>
                ))}
              </section>
            );
          default:
            return null;
        }
      })}
    </div>
  </article>
</BaseLayout>
