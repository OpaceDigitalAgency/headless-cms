---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlockRenderer from '../../../components/blocks/BlockRenderer.astro';
import ContentBlock from '../../../components/blocks/ContentBlock.astro';
import { getContentTypes, getContentTypeBySlugOrArchiveSlug, getCustomItemBySlug, getCustomItemsByType } from '../../../lib/payload';

export async function getStaticPaths() {
  const types = await getContentTypes();
  const paths: Array<{ params: { type: string; slug: string } }> = [];

  // Fetch items per content type to generate paths
  for (const type of types.docs) {
    const items = await getCustomItemsByType(type.id, { limit: 1000 });
    for (const item of items.docs) {
      paths.push({
        params: { type: type.slug, slug: item.slug },
      });
    }
  }

  return paths;
}

const { type, slug } = Astro.params;
const contentType = await getContentTypeBySlugOrArchiveSlug(type);

if (!contentType) {
  return Astro.redirect('/404');
}

const item = await getCustomItemBySlug(slug, contentType.id);

if (!item) {
  return Astro.redirect('/404');
}

const title = item.meta?.title || item.title;
const description = item.meta?.description || item.excerpt || '';
const image = item.meta?.image?.url || '';
const customFields = contentType.customFields || [];
const customData = item.customData || {};
---

<BaseLayout title={title} description={description} image={image}>
  <article class="py-16">
    <div class="container">
      <header class="mb-8">
        <h1 class="text-4xl font-bold">{item.title}</h1>
        {item.excerpt && <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">{item.excerpt}</p>}
      </header>

      {item.featuredImage?.url && (
        <img src={item.featuredImage.url} alt={item.featuredImage.alt || item.title} class="w-full rounded-lg mb-8" />
      )}

      <div class="grid gap-10 lg:grid-cols-4">
        <div class="lg:col-span-3 space-y-10">
          {item.content && <ContentBlock content={item.content} />}
          {item.blocks && item.blocks.length > 0 && <BlockRenderer blocks={item.blocks} />}
        </div>

        {customFields.length > 0 && (
          <aside class="lg:col-span-1 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
            <h2 class="text-lg font-semibold mb-4">Details</h2>
            <dl class="space-y-3 text-sm">
              {customFields.map((field: any) => (
                <div>
                  <dt class="text-gray-500">{field.label}</dt>
                  <dd class="font-medium">{customData[field.name] ?? 'â€”'}</dd>
                </div>
              ))}
            </dl>
          </aside>
        )}
      </div>
    </div>
  </article>
</BaseLayout>
