---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getArchiveItems, getArchiveItemBySlug } from '@/lib/payload';

export async function getStaticPaths() {
  const items = await getArchiveItems({ limit: 1000 });
  
  return items.docs.map((item) => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const itemData = item || await getArchiveItemBySlug(Astro.params.slug);

if (!itemData) {
  return Astro.redirect('/404');
}

const title = itemData.meta?.title || itemData.title;
const description = itemData.meta?.description || '';
const primaryImage = itemData.featuredImage || itemData.gallery?.[0]?.image;
---

<BaseLayout title={title} description={description} image={primaryImage?.url}>
  <article class="py-16">
    <div class="container">
      <div class="grid gap-12 lg:grid-cols-2">
        <!-- Image Gallery -->
        <div>
          {primaryImage?.url && (
            <div class="overflow-hidden rounded-xl">
              <img 
                src={primaryImage.url} 
                alt={primaryImage.alt || itemData.title}
                class="w-full h-auto"
              />
            </div>
          )}
          
          {itemData.gallery && itemData.gallery.length > 1 && (
            <div class="mt-4 grid grid-cols-4 gap-2">
              {itemData.gallery.slice(1).map((entry: any) => (
                <div class="overflow-hidden rounded-lg">
                  <img 
                    src={entry.image?.url} 
                    alt={entry.image?.alt || itemData.title}
                    class="w-full h-20 object-cover"
                  />
                </div>
              ))}
            </div>
          )}
        </div>
        
        <!-- Details -->
        <div>
          <h1 class="text-3xl font-bold tracking-tight lg:text-4xl">{itemData.title}</h1>
          
          {itemData.dateCreated && (
            <p class="mt-2 text-lg text-gray-500 dark:text-gray-400">{itemData.dateCreated}</p>
          )}
          
          <!-- Description -->
          {itemData.richContent && (
            <div class="mt-6 prose-custom" set:html={itemData.richContent_html} />
          )}
          
          <!-- Details Table -->
          <div class="mt-8 space-y-4">
            {itemData.specifications?.materials && (
              <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">Materials</h3>
                <div class="mt-1 flex flex-wrap gap-2">
                  <span class="rounded bg-gray-100 dark:bg-gray-800 px-2 py-1 text-sm">
                    {itemData.specifications.materials}
                  </span>
                </div>
              </div>
            )}
            
            {itemData.specifications && (
              <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">Specifications</h3>
                <p class="mt-1">
                  {itemData.specifications.height && `H: ${itemData.specifications.height}`}
                  {itemData.specifications.width && ` × W: ${itemData.specifications.width}`}
                  {itemData.specifications.depth && ` × D: ${itemData.specifications.depth}`}
                </p>
              </div>
            )}
            
            {itemData.provenance && (
              <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">Provenance</h3>
                <p class="mt-1">{itemData.provenance}</p>
              </div>
            )}
            
            {itemData.catalogNumber && (
              <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">Catalog Number</h3>
                <p class="mt-1">{itemData.catalogNumber}</p>
              </div>
            )}
          </div>
          
          <!-- Related Items -->
          {itemData.relatedItems && itemData.relatedItems.length > 0 && (
            <div class="mt-8">
              <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">Related Items</h3>
              <div class="mt-2 flex flex-wrap gap-2">
                {itemData.relatedItems.map((related: any) => (
                  <a 
                    href={`/archive-items/${related.slug}`}
                    class="text-blue-600 hover:text-blue-700 dark:text-blue-400"
                  >
                    {related.title}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
      
      <!-- Back link -->
      <div class="mt-12">
        <a href="/archive-items" class="text-blue-600 hover:text-blue-700 dark:text-blue-400">
          ← Back to Archive Items
        </a>
      </div>
    </div>
  </article>
</BaseLayout>
