---
import { getCategories, getCategoryContent } from '@/lib/payload';
import Layout from '@/layouts/Layout.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const categories = await getCategories({ limit: 1000 });
  
  return categories.docs.map((category: any) => ({
    params: { slug: category.slug },
  }));
}

const { slug } = Astro.params;
const data = await getCategoryContent(slug);

if (!data) {
  return Astro.redirect('/404');
}

const { category, content, counts } = data;

// Group content by collection type
const contentByType = {
  posts: content.filter((item: any) => item.collection === 'posts'),
  archiveItems: content.filter((item: any) => item.collection === 'archive-items'),
  events: content.filter((item: any) => item.collection === 'events'),
  people: content.filter((item: any) => item.collection === 'people'),
  customItems: content.filter((item: any) => item.collection === 'custom-items'),
};

const collectionLabels: Record<string, string> = {
  posts: 'Posts',
  archiveItems: 'Archive Items',
  events: 'Events',
  people: 'People',
  customItems: 'Custom Items',
};

const collectionPaths: Record<string, string> = {
  posts: '/blog',
  archiveItems: '/archive-items',
  events: '/events',
  people: '/people',
  customItems: '/items',
};
---

<Layout title={category.title} description={category.description || `All content in ${category.title}`}>
  <div class="container py-16">
    <header class="mb-12 text-center">
      <p class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">Category</p>
      <h1 class="mt-2 text-4xl font-bold tracking-tight text-gray-900 dark:text-white">
        {category.title}
      </h1>
      {category.description && (
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">
          {category.description}
        </p>
      )}
      <div class="mt-6 flex justify-center gap-4 text-sm text-gray-500 dark:text-gray-400">
        <span>{counts.total} total items</span>
        {counts.posts > 0 && <span>• {counts.posts} posts</span>}
        {counts.archiveItems > 0 && <span>• {counts.archiveItems} archive items</span>}
        {counts.events > 0 && <span>• {counts.events} events</span>}
        {counts.people > 0 && <span>• {counts.people} people</span>}
        {counts.customItems > 0 && <span>• {counts.customItems} custom items</span>}
      </div>
    </header>

    {content.length === 0 && (
      <div class="text-center text-gray-500 dark:text-gray-400">
        <p>No content found in this category.</p>
      </div>
    )}

    {Object.entries(contentByType).map(([type, items]) => {
      if (items.length === 0) return null;

      return (
        <section class="mb-16">
          <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">
            {collectionLabels[type]} ({items.length})
          </h2>
          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
            {items.map((item: any) => (
              <a
                href={`${collectionPaths[type]}/${item.slug}`}
                class="card overflow-hidden transition-shadow hover:shadow-md"
              >
                {item.featuredImage?.url && (
                  <div class="relative h-48">
                    <img
                      src={item.featuredImage.url}
                      alt={item.featuredImage.alt || item.title}
                      class="h-full w-full object-cover"
                    />
                  </div>
                )}
                <div class="p-6">
                  <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    {item.title}
                  </h3>
                  {item.excerpt && (
                    <p class="mt-2 text-gray-600 dark:text-gray-300 line-clamp-2">
                      {item.excerpt}
                    </p>
                  )}
                  {item.publishedAt && (
                    <p class="mt-4 text-sm text-gray-400">
                      {new Date(item.publishedAt).toLocaleDateString('en-GB', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </p>
                  )}
                </div>
              </a>
            ))}
          </div>
        </section>
      );
    })}
  </div>
</Layout>

