---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getMuseumCollections, getMuseumCollectionBySlug } from '@/lib/payload';

export async function getStaticPaths() {
  const collections = await getMuseumCollections({ limit: 1000 });
  
  return collections.docs.map((collection) => ({
    params: { slug: collection.slug },
    props: { collection },
  }));
}

const { collection } = Astro.props;
const collectionData = collection || await getMuseumCollectionBySlug(Astro.params.slug);

if (!collectionData) {
  return Astro.redirect('/404');
}

const title = collectionData.meta?.title || collectionData.title;
const description = collectionData.meta?.description || collectionData.shortDescription || '';
---

<BaseLayout title={title} description={description} image={collectionData.featuredImage?.url}>
  <article class="py-16">
    <div class="container">
      <!-- Header -->
      <header class="mb-12">
        <h1 class="text-3xl font-bold tracking-tight lg:text-4xl">{collectionData.title}</h1>
        
        {collectionData.shortDescription && (
          <p class="mt-4 text-xl text-gray-600 dark:text-gray-300">{collectionData.shortDescription}</p>
        )}
        
        {collectionData.curator && (
          <p class="mt-4 text-gray-500 dark:text-gray-400">
            Curated by: {collectionData.curator.name || collectionData.curator.email}
          </p>
        )}
      </header>
      
      <!-- Featured Image -->
      {collectionData.featuredImage?.url && (
        <div class="mb-12 overflow-hidden rounded-xl">
          <img 
            src={collectionData.featuredImage.url} 
            alt={collectionData.featuredImage.alt || collectionData.title}
            class="w-full h-auto max-h-96 object-cover"
          />
        </div>
      )}
      
      <!-- Description -->
      {collectionData.description_html && (
        <div class="prose-custom mb-12" set:html={collectionData.description_html} />
      )}
      
      <!-- Artifacts in Collection -->
      {collectionData.artifacts && collectionData.artifacts.length > 0 && (
        <section>
          <h2 class="text-2xl font-bold mb-6">Artifacts in this Collection</h2>
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {collectionData.artifacts.map((artifact: any) => {
              const image = artifact.media?.[0]?.image;
              return (
                <a href={`/artifacts/${artifact.slug}`} class="card overflow-hidden group">
                  {image?.url && (
                    <div class="relative h-40 overflow-hidden">
                      <img 
                        src={image.url} 
                        alt={image.alt || artifact.title}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    </div>
                  )}
                  <div class="p-3">
                    <h3 class="font-medium text-gray-900 dark:text-white">{artifact.title}</h3>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )}
      
      <!-- Back link -->
      <div class="mt-12">
        <a href="/collections" class="text-blue-600 hover:text-blue-700 dark:text-blue-400">
          ‚Üê Back to Collections
        </a>
      </div>
    </div>
  </article>
</BaseLayout>
